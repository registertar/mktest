<!doctype html>
<html>
    <head>
        <title>mktest</title>
        <script type="text/javascript">

            function getTagValue(text, tag) {
                pos1 = text.indexOf(tag);
                if (pos1 == -1) return null; // not found
                pos2 = text.indexOf('"', pos1);
                pos3 = text.indexOf('"', pos2+1);
                return text.substring(pos2+1,pos3); // can be "" or "value"
            }

            function addTableRow(a, b, c, d, e, f, g) {
                tableRef = document.getElementById("table");
                newRow = tableRef.insertRow(-1);

                newCell0 = newRow.insertCell(0);
                newCell0.innerHTML = a;
                newCell0.style = "vertical-align: top;";
                newCell1 = newRow.insertCell(1);
                newCell1.innerHTML = b;
                newCell1.style = "vertical-align: top;";
                newCell2 = newRow.insertCell(2);
                newCell2.innerHTML = c;
                newCell2.style = "vertical-align: top;";
                newCell3 = newRow.insertCell(3);
                newCell3.innerHTML = d;
                newCell3.style = "vertical-align: top;";
                newCell4 = newRow.insertCell(4);
                newCell4.innerHTML = e;
                newCell4.style = "vertical-align: top;";
                newCell5 = newRow.insertCell(5);
                newCell5.innerHTML = f;
                newCell5.style = "vertical-align: top;";
                newCell6 = newRow.insertCell(6);
                newCell6.innerHTML = g;
                newCell6.style = "vertical-align: top;";
            }

            async function getAPIResponseText(index, date) {
                try {
                    const body = new URLSearchParams();

                    body.append("ChannelIds", "3,1,2,30,33,4,34,");
                    body.append("ShortCodes", "dn,m1,m2,m4,m5,dw,m4p,");
                    body.append("Names", "Duna,M1,M2,M4+Sport,M5,Duna+World,M4+Sport++,");
                    body.append("Date", date);
                    body.append("Type", "0");
                    body.append("buttonType", "text_type");
                    body.append("newDesign", "true");
                    body.append("debug", "0");

                    const response = await fetch("https://mediaklikk.hu/wp-content/plugins/hms-global-widgets/widgets/programGuide/programGuideInterface.php", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: body.toString(),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const responseText = await response.text();
                    
                    const textItemsArray = responseText.split('</li>');

                    for (var i = 0; i < textItemsArray.length; i++)
                    {
                        text = textItemsArray[i];
                        data_videolink = getTagValue(text,"data-videolink");

                        if (data_videolink) { // there is recording
                            data_from = getTagValue(text,"data-from");
                            data_till = getTagValue(text,"data-till");

                            if (data_from && data_till) {
                                from = new Date(data_from);
                                till = new Date(data_till);
                                length = Math.floor((till - from) / 1000 / 60); // milliseconds --> minutes

                                if (length >= 60) { // long enough
                                    lengthHours = Math.floor(length / 60);
                                    lengthMinutes = length % 60;

                                    // class="elo dn "
                                    channel = "";
                                    temp = text.match(/class="elo\s+(\w+)\s*"/);
                                    if (temp != null && temp.length >= 2) {
                                        channel = temp[1];
                                    }

                                    if (channel != "m1") {

                                        icon = "";
                                        switch (channel) {
                                            case "m2":
                                                icon = "üéµ";
                                                break;
                                            case "m4":
                                            case "m4p":
                                                icon = "ü§æ";
                                                break;
                                            case "m5":
                                                icon = "üé≠";
                                                break;
                                            default:
                                                break;
                                        }

                                        // div class="program_info" / <h1>
                                        title = "";
                                        split = text.split("program_info");
                                        if (split != null && split.length >= 2) {
                                            temp = split[1].match(/<h1>(.*?)<\/h1>/);
                                            if (temp != null && temp.length >= 2) {
                                                title = temp[1];
                                            }
                                        }

                                        // div class="program_info" / <p> or <p >
                                        title2 = "";
                                        split = text.split("program_info");
                                        if (split != null && split.length >= 2) {
                                            temp = split[1].match(/<p(.*?)<\/p>/);
                                            if (temp != null && temp.length >= 2) {
                                                title2 = temp[1].split(">")[1];
                                            }
                                        }

                                        // div class="program_description" / <p> or <p >
                                        description = "";
                                        split = text.split("program_description");
                                        if (split != null && split.length >= 2) {
                                            temp = split[1].match(/<p(.*?)<\/p>/);
                                            if (temp != null && temp.length >= 2) {
                                                description = temp[1].split(">")[1];
                                            }
                                        }
                                        
                                        addTableRow(
                                            "<div>" + index + "</div>",
                                            "<div>" + date + "</div>",
                                            "<div>" + channel + "</div>",
                                            "<div>" + icon + "</div>",
                                            "<div>" + lengthHours + ":" + ('00' + lengthMinutes).substr(-2) + "</div>",
                                            "<div><a href=" + data_videolink + ">" + title + "</a></div>",
                                            "<div>" + title2 + "</div><div>" + description + "</div>"
                                        );
                                    }
                                }
                            }
                        }
                    }

                    counterRef = document.getElementById("counter");
                    counterRef.innerHTML = index;

                } catch (error) {
                    console.error('Fetch error:', error);
                }
            }
            
            async function callAPIs() {
                for (index = 0; index <= 60; index++) {    // max 60 days history, recent days in the beginning
                    d = new Date(); // today
                    d.setDate(d.getDate() - index);
                    date = d.getFullYear() + "-" + ('00' + (d.getMonth() + 1)).substr(-2) + "-" + ('00' + d.getDate()).substr(-2); // getMonth is zero-based
                    console.log(date);
                    await getAPIResponseText(index, date);
                }
            }

            document.addEventListener('readystatechange', event => { 
                // When window loaded
                if (event.target.readyState === "complete") {
                    callAPIs();
                }
            });
        </script>
    </head>
    <body>
        <div id="counter">...</div>
        <table id="table" border="1px solid black"></table>
    </body>
</html>

<!-- example item section

<li class="program_body m5   available " 
    style="" 
    data-from="2025-09-13 21:03:55+0200" data-till="2025-09-13 22:25:54+0200" 
    data-bci="1" data-vpi="8787207 "data-vpslug="kalman-imre-a-cirkuszhercegno"  data-videolink="https://mediaklikk.hu/kultura/video/2025/09/15/kultura/kalman-imre-a-cirkuszhercegno">
    <div class="time">
        <time >21:03</time>
        <div class="elo m5 " style="display: none" onclick="window.open('https://mediaklikk.hu/kultura/video/2025/09/15/kultura/kalman-imre-a-cirkuszhercegno', '_programguide_playbackPopupVideo')"><span class="live_play"></span>√âl≈ë</div>
        <div class="status available "></div>
    </div>
    <div class="program_data">
        <div class="program_info">
            <h1> K√°lm√°n Imre: A cirkuszhercegn≈ë </h1>
            <p style='display: none'></p>
            <div class="isOpenIndicator"></div>
            <div class="adultContentLimit"><div class="acl-0">0</div></div>
        </div>
        <div class="program_about" style="display: none;">
            <div class="program_description" >
                <p>A Cirkuszhercegn≈ë K√°lm√°n Imre egyik legl√°tv√°nyosabb √©s legszenved√©lyesebb operettje, amely a cirkusz var√°zslatos vil√°g√°t √∂tv√∂zi a m≈±faj elb≈±v√∂l≈ë romantik√°j√°val. A t√∂rt√©net k√∂z√©ppontj√°ban egy titokzatos herceg √©s egy b√°tor artistal√°ny sorsa fon√≥dik √∂ssze, mik√∂zben a h√°tt√©rben fel-felbukkan a m√∫lt, a szerelem √©s az √°larc m√∂g√© rejtett igazs√°g. A darab leny≈±g√∂z≈ë zenei anyaga ‚Äì k√∂zt√ºk a h√≠res Zweiten Cs√°rd√°s ‚Äì a korabeli pesti √©s b√©csi sz√≠npadok f√©ny√©t id√©zi. A Budapesti Operettsz√≠nh√°z el≈ëad√°s√°ban a klasszikus operettform√°t modern sz√≠nh√°zi eszk√∂z√∂kkel √©s cirkuszi l√°tv√°nyelemekkel √∂tv√∂zt√©k. A rendez≈ë, Homonnay Zsolt kell≈ë √©rz√©kenys√©ggel √©s finoms√°ggal teremtett egyens√∫lyt a l√°tv√°nyos show-elemek √©s a m√©ly √©rzelmek k√∂z√∂tt. A nagy√≠v≈± szerelmi t√∂rt√©net, a finom humor √©s a var√°zslatos d√≠szletek egy√ºtt teremtenek felejthetetlen sz√≠nh√°zi √©lm√©nyt. A porondon √©s a kulissz√°k m√∂g√∂tt is izzik a fesz√ºlts√©g, mik√∂zben a n√©z≈ëk egy est√©re a csod√°k birodalm√°ba cs√∂ppenhetnek.</p>
            </div>
            <button class="playback" onclick="window.open('https://mediaklikk.hu/kultura/video/2025/09/15/kultura/kalman-imre-a-cirkuszhercegno', '_programguide_playbackPopupVideo')">N√©zze vissza</button>
            
        </div>
    </div>
</li>

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_expressions/Cheatsheet

-->

